<!DOCTYPE html>
<html>
<head>
  <title>Calendar Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #fdf6e3;
    }
    h1, h2, p {
      text-align: center;
    }
    #calendarOutput {
      margin-top: 30px;
      text-align: left;
      font-size: 20px;
      max-height: 600px;
      overflow-y: auto;
      overflow-x: visible;
    }
    .nav-buttons {
      text-align: center;
      margin-top: 20px;
    }
    button {
      font-size: 16px;
      padding: 10px 20px;
      margin: 0 10px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
    }
    button:hover {
      background: #f0e6d2;
    }
    table {
      margin: 0;
      font-size: 16px;
      border-collapse: collapse;
      table-layout: auto;
      width: auto;
    }
    th, td {
      padding: 6px 12px;
      border: 1px solid #ccc;
      vertical-align: top;
    }
    td.normal-cell {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    td.overflow-cell {
      position: relative;
      white-space: nowrap;
      overflow: visible;
      text-overflow: clip;
      max-width: 60px;
    }
    thead tr {
      position: sticky;
      top: 0;
      background: #f0e6d2;
      z-index: 1;
    }
    #columnToggles {
      text-align: center;
      margin: 15px 0;
    }
    #columnToggles label {
      margin: 0 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>üìÖ Calendar Viewer</h1>
  <h2 id="calendarTitle"></h2>
  <p id="calendarNote"></p>

  <div class="nav-buttons">
    <button onclick="goBack()">üîô Back to Start</button>
    <button onclick="changeYear(-1)">‚¨ÖÔ∏è Previous Year</button>
    <button onclick="changeYear(1)">‚û°Ô∏è Next Year</button>
    <button onclick="window.location.href='contact.html'">üì® Contact</button>
  </div>

  <div id="columnToggles"></div>
  <div id="calendarOutput">Loading calendar data‚Ä¶</div>

  <script>
    let currentParams = {};

    function getParams() {
      const urlParams = new URLSearchParams(window.location.search);
      return {
        type: urlParams.get('type'),
        year: parseInt(urlParams.get('year')),
        era: urlParams.get('era')
      };
    }

    function goBack() {
      window.location.href = 'index.html';
    }

    function changeYear(offset) {
      let { year, era, type } = currentParams;

      // Convert to signed year
      let signedYear = era === 'BC' ? -year : year;

      // Apply offset
      signedYear += offset;

      // Skip year 0
      if (signedYear === 0) {
        signedYear = offset > 0 ? 1 : -1;
      }

      // Normalize back to year and era
      year = Math.abs(signedYear);
      era = signedYear < 0 ? 'BC' : 'AD';

      const newParams = new URLSearchParams({ type, year, era });
      window.location.href = `viewer.html?${newParams.toString()}`;
    }

    function renderCalendar({ type, year, era }) {
      currentParams = { type, year, era };

      document.getElementById('calendarTitle').textContent = `${type} Calendar ‚Äî ${year} ${era}`;

      let note = '';
      if (type === 'Gregorian') {
        note = 'Gregorian calendar (valid from 1583 AD onward).';
      } else if (type === 'Julian') {
        note = 'Julian calendar (valid from 532 AD to 1582 AD).';
      } else {
        note = 'Historical calendar (531 AD ‚Üí 1 AD, then 1 BC and earlier).';
      }
      document.getElementById('calendarNote').textContent = note;

      const filename = `CalendarApp/${type}_${year}_${era}.csv`;
      fetch(filename)
        .then(response => {
          if (!response.ok) throw new Error("File not found");
          return response.text();
        })
        .then(csv => {
          const rows = csv.trim().split('\n').map(line =>
            line.split(',').map(cell => cell.trim())
          );

          let html = '<table id="calendarTable"><thead><tr>';
          rows[0].forEach(cell => {
            html += `<th scope="col">${cell}</th>`;
          });
          html += '</tr></thead><tbody>';
          rows.slice(1).forEach(row => {
            html += '<tr>';
            row.forEach(cell => {
              let cellClass = cell.includes('|') ? 'overflow-cell' : 'normal-cell';
              html += `<td class="${cellClass}" title="${cell}">${cell}</td>`;
            });
            html += '</tr>';
          });
          html += '</tbody></table>';
          document.getElementById('calendarOutput').innerHTML = html;

          const toggleContainer = document.getElementById('columnToggles');
          toggleContainer.innerHTML = '';
          rows[0].forEach((header, index) => {
            const id = `colToggle${index}`;
            toggleContainer.innerHTML += `
              <label>
                <input type="checkbox" id="${id}" checked onchange="toggleColumn(${index}, this.checked)">
                ${header}
              </label>
            `;
          });
        })
        .catch(error => {
          console.error("Fetch error:", error);
          document.getElementById('calendarOutput').textContent =
            `‚ö†Ô∏è No calendar data found for ${year} ${era} (${type}). Try a different year or calendar type.`;
        });
    }

    function toggleColumn(colIndex, show) {
      const table = document.getElementById('calendarTable');
      if (!table) return;

      for (let row of table.rows) {
        if (row.cells[colIndex]) {
          row.cells[colIndex].style.display = show ? '' : 'none';
        }
      }
    }

    renderCalendar(getParams());
  </script>
</body>
</html>

